<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Score</title>
<style>
:root{color-scheme:dark;--bg:#000;--card:#111;--border:#333;--btn:#1e88e5;--red:#c62828;--green:#2e7d32;--muted:#aaa;--chip:#151515}
body{margin:0;font-family:system-ui,-apple-system;background:var(--bg);color:#fff}
h1{margin:16px}
.card{border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px;background:var(--card)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button,input{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#222;color:#fff;font-size:15px}
button.primary{background:var(--btn);border:none;font-weight:800}
button:active{opacity:.85}
input[type="number"]{width:80px;text-align:center}
input[type="text"]{width:150px}
.small{font-size:13px;color:var(--muted);margin:6px 0 0}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid var(--border)}
td.nameCell{cursor:pointer}
tr.top{background:var(--red)}   /* TOP = RED */
tr.low{background:var(--green)}/* LOW = GREEN */
tr.out{opacity:.35}
.history{font-size:13px;color:var(--muted);margin-top:10px;line-height:1.4}
.pill{display:inline-block;padding:2px 8px;border:1px solid #666;border-radius:999px;font-size:12px;margin-inline-start:8px;opacity:.9;background:var(--chip)}
.status{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);font-size:12px;color:var(--muted)}
.toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--chip)}
#err{display:none;white-space:pre-wrap;border:1px solid #b71c1c;background:#2a0000;color:#ffb4b4;border-radius:12px;padding:10px;margin-top:10px;font-size:12px}
</style>
</head>
<body>

<h1 id="title">üéÆ Game Score</h1>

<div class="card" id="setupCard">
  <div class="row">
    <span id="lblPlayers">Players</span>
    <input id="playersCount" type="number" min="2" max="10" value="2">
    <button class="primary" id="btnStart">Start / New Game</button>
  </div>

  <div class="row" style="margin-top:10px">
    <span id="lblLang">Language</span>
    <button id="btnAR">AR</button>
    <button id="btnEN">EN</button>
  </div>

  <p class="small" id="tip">Tip: This app auto-saves.</p>
</div>

<div class="card" id="gameCard" style="display:none">
  <div class="row">
    <button id="btnAddRound">‚ûï Add Round</button>
    <button id="btnAddPlayer">üë§ Add Player</button>
    <button id="btnNewGame" class="primary">üÜï New Game</button>
    <button id="btnGoSetup">‚öôÔ∏è Setup</button>
    <button id="btnReset">üîÑ Reset</button>
  </div>

  <div class="row" style="margin-top:10px">
    <span id="lblKick">Kick-out at</span>
    <input id="target" type="number" min="1" value="100">
    <span class="small" id="lblHint">Players become OUT when total ‚â• target.</span>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="toggle">
      <input id="doubleToggle" type="checkbox">
      <label id="lblDouble" for="doubleToggle" style="cursor:pointer">x2 Double scores</label>
    </div>

    <div class="toggle">
      <span id="lblRoom">Room</span>
      <input id="roomInput" type="text" placeholder="majlis1" autocapitalize="none" autocomplete="off">
      <button id="btnSetRoom">Set</button>
      <button id="btnShareRoom">Share</button>
    </div>

    <span class="status" id="syncStatus">Local</span>
  </div>

  <div id="err"></div>

  <table id="table">
    <thead>
      <tr>
        <th id="thPlayer">Player</th>
        <th id="thTotal">Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="history" id="history"></div>
</div>

<script>
/* ======= Error box so we SEE the problem on iPhone ======= */
const errBox = document.getElementById("err");
function showErr(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
window.onerror = (m, src, line, col) => {
  showErr("JS ERROR:\\n" + m + "\\n" + (src||"") + ":" + line + ":" + col);
};

/* ======= Firebase config (yours) ======= */
const FIREBASE_ENABLED = true;
const firebaseConfig = {
  apiKey: "AIzaSyC0twO6-07rT8NNwqVOlLDpwRIakjC122Y",
  authDomain: "ceck-21719.firebaseapp.com",
  databaseURL: "https://ceck-21719-default-rtdb.firebaseio.com",
  projectId: "ceck-21719",
  storageBucket: "ceck-21719.firebasestorage.app",
  messagingSenderId: "747335920443",
  appId: "1:747335920443:web:d65ff3f8ed4b801e3a651e",
  measurementId: "G-N68P7BHP86"
};

/* ======= App state ======= */
const $ = (id)=>document.getElementById(id);
const KEY="gameScore_live_safe_v1";
const KEY_ROOM="gameScore_room_safe_v1";
const KEY_CID="gameScore_cid_safe_v1";

let clientId = localStorage.getItem(KEY_CID) || ("c_"+Math.random().toString(36).slice(2)+Date.now().toString(36));
localStorage.setItem(KEY_CID, clientId);

let room = localStorage.getItem(KEY_ROOM) || "";

let state = {
  lang: "en",
  names: [],
  totals: [],
  out: [],
  history: [],
  target: 100,
  double: false
};

const I18N = {
  en:{title:"üéÆ Game Score",players:"Players",start:"Start / New Game",lang:"Language",tip:"Tip: This app auto-saves.",
      addRound:"‚ûï Add Round",addPlayer:"üë§ Add Player",newGame:"üÜï New Game",setup:"‚öôÔ∏è Setup",reset:"üîÑ Reset",
      kick:"Kick-out at",hint:"Players become OUT when total ‚â• target.",thPlayer:"Player",thTotal:"Total",
      editName:"Edit name",pointsFor:"Round points for",round:"Round",out:"OUT",maxPlayers:"Max players is 10.",
      confirmReset:"Reset all totals and set everyone IN?",confirmNew:"Start a new game? (clears current)",
      double:"x2 Double scores",room:"Room",set:"Set",share:"Share",local:"Local",live:"Live",roomFirst:"Set a Room first",copied:"Link copied"},
  ar:{title:"üéÆ ŸÜŸÇÿßÿ∑ ÿßŸÑŸÑÿπÿ®ÿ©",players:"ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ",start:"ÿßÿ®ÿØÿ£ / ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",lang:"ÿßŸÑŸÑÿ∫ÿ©",tip:"ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿπŸÑŸâ ÿßŸÑÿ¨Ÿáÿßÿ≤.",
      addRound:"‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ŸàŸÑÿ©",addPlayer:"üë§ ÿ•ÿ∂ÿßŸÅÿ© ŸÑÿßÿπÿ®",newGame:"üÜï ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",setup:"‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™",reset:"üîÑ ÿ™ÿµŸÅŸäÿ±",
      kick:"ÿßŸÑÿ•ŸÇÿµÿßÿ° ÿπŸÜÿØ",hint:"Ÿäÿµÿ®ÿ≠ ÿßŸÑŸÑÿßÿπÿ® OUT ÿπŸÜÿØŸÖÿß ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ‚â• ÿßŸÑŸáÿØŸÅ.",thPlayer:"ÿßŸÑŸÑÿßÿπÿ®",thTotal:"ÿßŸÑŸÖÿ¨ŸÖŸàÿπ",
      editName:"ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿßÿ≥ŸÖ",pointsFor:"ŸÜŸÇÿßÿ∑ ÿßŸÑÿ¨ŸàŸÑÿ© ŸÑŸÄ",round:"ÿ¨ŸàŸÑÿ©",out:"OUT",maxPlayers:"ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 10 ŸÑÿßÿπÿ®ŸäŸÜ.",
      confirmReset:"ÿ™ÿµŸÅŸäÿ± ŸÉŸÑ ÿßŸÑŸÜŸÇÿßÿ∑ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ¨ŸÖŸäÿπ INÿü",confirmNew:"ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©ÿü (ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ÿßŸÑŸä)",
      double:"x2 ŸÖÿ∂ÿßÿπŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑",room:"ÿßŸÑÿ∫ÿ±ŸÅÿ©",set:"ÿ™ÿπŸäŸäŸÜ",share:"ŸÖÿ¥ÿßÿ±ŸÉÿ©",local:"ŸÖÿ≠ŸÑŸä",live:"ŸÖÿ®ÿßÿ¥ÿ±",roomFirst:"ÿ≠ÿØÿØ Room ÿ£ŸàŸÑÿßŸã",copied:"ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑"}
};
function t(k){ return (I18N[state.lang]||I18N.en)[k] || k; }

function saveLocal(){
  state.target = Math.max(1, Math.floor(Number($("target").value)||100));
  state.double = !!$("doubleToggle").checked;
  localStorage.setItem(KEY, JSON.stringify(state));
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(KEY);
    if(raw) state = {...state, ...JSON.parse(raw)};
  }catch{}
}
function setSyncBadge(text){
  $("syncStatus").textContent = text;
}
function applyLang(){
  document.documentElement.lang = state.lang;
  document.documentElement.dir  = (state.lang==="ar") ? "rtl" : "ltr";
  $("title").textContent = t("title");
  $("lblPlayers").textContent = t("players");
  $("btnStart").textContent = t("start");
  $("lblLang").textContent = t("lang");
  $("tip").textContent = t("tip");
  $("btnAddRound").textContent = t("addRound");
  $("btnAddPlayer").textContent = t("addPlayer");
  $("btnNewGame").textContent = t("newGame");
  $("btnGoSetup").textContent = t("setup");
  $("btnReset").textContent = t("reset");
  $("lblKick").textContent = t("kick");
  $("lblHint").textContent = t("hint");
  $("thPlayer").textContent = t("thPlayer");
  $("thTotal").textContent = t("thTotal");
  $("lblDouble").textContent = t("double");
  $("lblRoom").textContent = t("room");
  $("btnSetRoom").textContent = t("set");
  $("btnShareRoom").textContent = t("share");
  setSyncBadge(room && firebaseReady ? `${t("live")}: ${room}` : t("local"));
}

function showSetup(){ $("setupCard").style.display=""; $("gameCard").style.display="none"; }
function showGame(){
  $("setupCard").style.display="none"; $("gameCard").style.display="";
  $("target").value = state.target || 100;
  $("doubleToggle").checked = !!state.double;
  $("roomInput").value = room || "";
  render();
}

function newGame(n){
  state.names = Array.from({length:n}, (_,i)=>`Player ${i+1}`);
  state.totals = Array(n).fill(0);
  state.out = Array(n).fill(false);
  state.history = [];
  saveLocal();
}

function computeTopLow(){
  const inIdx = state.totals.map((_,i)=>i).filter(i=>!state.out[i]);
  if(inIdx.length===0) return {top:-1,low:-1,allEqual:true};
  let top=inIdx[0], low=inIdx[0];
  for(const i of inIdx){
    if(state.totals[i] > state.totals[top]) top=i;
    if(state.totals[i] < state.totals[low]) low=i;
  }
  const allEqual = inIdx.every(i=>state.totals[i]===state.totals[inIdx[0]]);
  return {top,low,allEqual};
}

function render(){
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML="";
  const {top,low,allEqual}=computeTopLow();

  state.names.forEach((name,i)=>{
    const tr=document.createElement("tr");
    if(state.out[i]) tr.classList.add("out");
    if(!state.out[i] && !allEqual && i===top) tr.classList.add("top");
    if(!state.out[i] && !allEqual && i===low) tr.classList.add("low");

    const tdN=document.createElement("td");
    tdN.className="nameCell";
    tdN.innerHTML = name + (state.out[i]?` <span class="pill">${t("out")}</span>`:"");
    tdN.onclick=()=>{ const v=prompt(t("editName"), state.names[i]); if(v!==null && v.trim()) {state.names[i]=v.trim(); saveLocal(); render(); writeRemoteDebounced(true);} };

    const tdT=document.createElement("td");
    tdT.textContent=String(state.totals[i]);

    tr.appendChild(tdN); tr.appendChild(tdT); tbody.appendChild(tr);
  });

  $("history").innerHTML = state.history.slice(0,12).map(h=>"‚Ä¢ "+h).join("<br>");
}

/* ======= Firebase Live Share (loads ONLY after Set Room) ======= */
let firebaseReady=false;
let firebaseDb=null;
let listenerRef=null;
let lastAppliedTs=0;
let writeTimer=null;

function loadScript(src){
  return new Promise((res, rej)=>{
    const s=document.createElement("script");
    s.src=src; s.async=true; s.onload=res; s.onerror=rej;
    document.head.appendChild(s);
  });
}

async function ensureFirebase(){
  if(!FIREBASE_ENABLED) return false;
  if(firebaseReady && firebaseDb) return true;
  try{
    await loadScript("https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js");
    if(!firebase.apps || firebase.apps.length===0) firebase.initializeApp(firebaseConfig);
    firebaseDb = firebase.database();
    firebaseReady=true;
    return true;
  }catch(e){
    firebaseReady=false; firebaseDb=null;
    showErr("Firebase blocked/failed to load. App still works locally.");
    return false;
  }
}

function cleanRoom(s){ return (s||"").trim().toLowerCase().replace(/[^a-z0-9_-]/g,"").slice(0,24); }
function roomPath(r){ return `rooms/${r}/state`; }

function attachListener(){
  if(!firebaseReady || !firebaseDb || !room) return;
  if(listenerRef){ listenerRef.off(); listenerRef=null; }
  listenerRef = firebaseDb.ref(roomPath(room));
  listenerRef.on("value", snap=>{
    const remote = snap.val();
    if(!remote || remote._by===clientId) return;
    const ts = Number(remote._ts||0);
    if(ts<=lastAppliedTs) return;
    lastAppliedTs=ts;

    state = { ...state, ...remote };
    $("target").value = state.target || 100;
    $("doubleToggle").checked = !!state.double;

    saveLocal();
    applyLang();
    render();
    setSyncBadge(`${t("live")}: ${room}`);
  });
  setSyncBadge(`${t("live")}: ${room}`);
}

function writeRemoteNow(){
  if(!room || !firebaseReady || !firebaseDb) return;
  const payload = {
    lang: state.lang,
    names: state.names,
    totals: state.totals,
    out: state.out,
    history: state.history,
    target: Math.max(1, Math.floor(Number($("target").value)||state.target||100)),
    double: !!$("doubleToggle").checked,
    _by: clientId,
    _ts: Date.now()
  };
  firebaseDb.ref(roomPath(room)).set(payload).catch(()=>{});
}

function writeRemoteDebounced(){
  clearTimeout(writeTimer);
  writeTimer=setTimeout(writeRemoteNow, 250);
}

async function setRoom(){
  const r = cleanRoom($("roomInput").value);
  if(!r){ room=""; localStorage.removeItem(KEY_ROOM); setSyncBadge(t("local")); return; }
  room=r; localStorage.setItem(KEY_ROOM, room);

  const ok = await ensureFirebase();
  if(!ok){ setSyncBadge(t("local")); return; }

  attachListener();
  writeRemoteNow(); // publish current state
}

async function shareRoom(){
  if(!room) return alert(t("roomFirst"));
  const url = new URL(location.href);
  url.searchParams.set("room", room);
  url.searchParams.set("lang", state.lang);
  const link = url.toString();
  if(navigator.share){
    try{ await navigator.share({title:"Game Score", url:link, text:link}); }catch{}
  }else{
    try{ await navigator.clipboard.writeText(link); alert(t("copied")); }
    catch{ prompt("Copy link", link); }
  }
}

/* ======= Wire UI ======= */
$("btnStart").onclick = () => {
  const n = Math.max(2, Math.min(10, Math.floor(Number($("playersCount").value)||2)));
  newGame(n);
  for(let i=0;i<state.names.length;i++){
    const v = prompt(`Name for ${state.names[i]}`, state.names[i]);
    if(v===null) break;
    if(v.trim()) state.names[i]=v.trim();
  }
  saveLocal();
  showGame();
  render();
  writeRemoteDebounced();
};

$("btnAddRound").onclick = () => {
  const inIdx = state.names.map((_,i)=>i).filter(i=>!state.out[i]);
  if(inIdx.length===0) return;

  state.target = Math.max(1, Math.floor(Number($("target").value)||100));
  state.double = !!$("doubleToggle").checked;
  const mult = state.double ? 2 : 1;

  const changes=[];
  for(const i of inIdx){
    const v = prompt(`${t("pointsFor")} ${state.names[i]}${mult===2?" (√ó2)":""}`, "0");
    if(v===null) return;
    let pts = Number(v); if(!Number.isFinite(pts)) pts=0;
    pts *= mult;
    state.totals[i] += pts;
    changes.push(`${state.names[i]} +${pts}`);
    if(state.totals[i] >= state.target) state.out[i]=true;
  }
  state.history.unshift(`${t("round")}: ${changes.join(", ")}`);
  saveLocal(); render(); writeRemoteDebounced();
};

$("btnAddPlayer").onclick = () => {
  if(state.names.length>=10) return alert(t("maxPlayers"));
  const v = prompt(t("addPlayer"), `Player ${state.names.length+1}`);
  if(v===null) return;
  state.names.push(v.trim()||`Player ${state.names.length+1}`);
  state.totals.push(0);
  state.out.push(false);
  saveLocal(); render(); writeRemoteDebounced();
};

$("btnReset").onclick = () => {
  if(!confirm(t("confirmReset"))) return;
  state.totals = state.totals.map(()=>0);
  state.out = state.out.map(()=>false);
  state.history = [];
  saveLocal(); render(); writeRemoteDebounced();
};

$("btnNewGame").onclick = () => { if(confirm(t("confirmNew"))) showSetup(); };
$("btnGoSetup").onclick = showSetup;

$("btnAR").onclick = () => { state.lang="ar"; saveLocal(); applyLang(); render(); writeRemoteDebounced(); };
$("btnEN").onclick = () => { state.lang="en"; saveLocal(); applyLang(); render(); writeRemoteDebounced(); };

$("target").onchange = () => { state.target=Math.max(1, Math.floor(Number($("target").value)||100)); state.out=state.totals.map(x=>x>=state.target); saveLocal(); render(); writeRemoteDebounced(); };
$("doubleToggle").onchange = () => { state.double=!!$("doubleToggle").checked; saveLocal(); writeRemoteDebounced(); };

$("btnSetRoom").onclick = setRoom;
$("btnShareRoom").onclick = shareRoom;

/* ======= Boot ======= */
loadLocal();
room = localStorage.getItem(KEY_ROOM) || room;

try{
  const sp = new URLSearchParams(location.search);
  const r = cleanRoom(sp.get("room"));
  const l = sp.get("lang");
  if(l==="ar"||l==="en") state.lang=l;
  if(r) room=r, localStorage.setItem(KEY_ROOM, room);
}catch{}

applyLang();
if(state.names && state.names.length>=2) showGame(); else showSetup();
$("roomInput").value = room || "";
setSyncBadge(t("local"));
</script>
</body>
</html>
